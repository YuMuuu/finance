copy from: https://github.com/apache/spark/pull/52519